# GIT

alias gds="git diff --staged"
alias gaa="ga . -N"
alias grm="git status | grep deleted | awk '{print \$3}' | xargs git rm"
alias gll="git log --pretty=format:'%C(yellow)%h %C(cyan)%ad %Creset%s%Cred [%cn]' --decorate --date=short"
alias gm="git merge"
alias gap="git add --patch"
alias gss="git stash save"
alias gsl="git stash list"

function gsa () {
  if [ -z "$1" ]; then
    STASH=0
  else
    STASH=$1
  fi
  git stash apply stash@{$STASH}
}

function timesheet () {
  if [ -z "$1" ]; then
    SINCE="8am"
  else
    SINCE=$1
  fi
  git log --oneline --author="`git config --get user.name`" --since=$SINCE
}

function gundo () {
  git reset --soft HEAD~1 &&
  git reset HEAD `git status -s | tr -d 'M' | tr -d '\n'`
}

# Fix oh-my-zsh's git plugin conflict
if type gclean > /dev/null; then
  unalias gclean
fi

function gclean () {
  gcm &&
  ggpull &&
  git remote prune origin &&
  git fetch &&
  git branch -a --merged | grep -v -E 'master|stable|staging' | sed 's/^/git branch -d/' | sed 's/branch -d  remotes\/origin\//push origin :/'
}

function gbf () {
  if [ -z "$1" ]; then
    red 'creating feature branch: missing required argument branch name'
  else
    git checkout -b feature_$1
  fi
}

function gbh () {
  if [ -z "$1" ]; then
    red 'creating hotfix branch: missing required argument branch name'
  else
    git checkout -b hotfix_$1
  fi
}

function gbrc () {
  if [ -z "$1" ]; then
    red 'creating release candidate branch: missing required argument branch name'
  else
    git checkout -b rc_$1
  fi
}

function gtag () {
  if [ -z "$1" ]; then
    red 'bumping version: missing required argument version number'
  else
    git checkout master
    git commit -am 'Bump version v'$1
    git push origin master
    git checkout stable
    git merge master
    git tag v$1
    git push origin stable
    git push --tags
    git checkout master
  fi
}

# EDITOR

alias subl="/Applications/Sublime\ Text.app/Contents/SharedSupport/bin/subl"

# SPORK

alias td="nocorrect testdrb -Itest"

# RAILS

alias t="ruby -Itest"
alias fs="foreman start"
alias fsd="foreman start -f Procfile.development"
alias sss="RAILS_ENV=test rake sunspot:solr:start"
alias frc="foreman run rails console"
alias frg="foreman run guard"
alias bi="bundle install -j4"

function init () {
  if [ $# -eq 1 ]; then
    echo $1 > .ruby-version
  fi

  echo `basename $PWD` > .rbenv-gemsets
  reload
  gem install bundler --pre && bundle -j4
}

# POSTGRESQL

function resetdb () {
  if [ -z "$1" ]; then
    red 'resetdb: missing required argument database name'
  else
    dropdb $1 && createdb $1
  fi
}

function restoredb () {
  if [ -z "$1" ]; then
    red 'restoredb: missing required argument database name'
  else
    if [ -z "$2" ]; then
      red 'restoredb: missing required argument dump file'
    else
      pg_restore --verbose --clean --no-acl --no-owner -h localhost -d $1 $2
    fi
  fi
}

function dumpdb () {
  if [ -z "$1" ]; then
    red 'dumpdb: missing required argument database name'
  else
    if [ -z "$2" ]; then
      red 'dumpdb: missing required argument dump file'
    else
      pg_dump -Fc $1 > $2_`date +%Y%m%d%H%M%S`.dump
    fi
  fi
}

function hedumpdb () {
  if [ -z "$1" ]; then
    red 'hedumpdb: missing required argument app name'
  else
    heroku pgbackups:capture --expire --app $1
    now=`date +%Y%m%d%H%M%S`
    backup_url=`heroku pgbackups:url --app $1`
    echo "curl -o $1_$now.dump $backup_url" | pbcopy
    green 'curl dump copy in clipboard'
  fi
}

# ZSH

alias thin="nocorrect thin"
alias thor="nocorrect thor"
alias npm="nocorrect npm"
alias grunt="nocorrect grunt"
alias guard="nocorrect bundle exec guard"
alias neat="nocorrect neat"
alias rspec="nocorrect rspec"
alias reload="echo \`pwd\` > ~/.RELOAD && source ~/.zshrc"
alias pk='nocorrect pk'
alias reek='nocorrect reek -n -c ~/.reek'

# SSH

alias myssh="pbcopy < ~/.ssh/id_rsa.pub"

# IP

alias ip="dig +short myip.opendns.com @resolver1.opendns.com"
alias localip="ipconfig getifaddr en1"
alias myip="localip"

# ARCHIVE

function extract () {
  if [ -f $1 ] ; then
    case $1 in
      *.tar.bz2)   tar xjf $1     ;;
      *.tar.gz)    tar xzf $1     ;;
      *.bz2)       bunzip2 $1     ;;
      *.rar)       unrar e $1     ;;
      *.gz)        gunzip $1      ;;
      *.tar)       tar xf $1      ;;
      *.tbz2)      tar xjf $1     ;;
      *.tgz)       tar xzf $1     ;;
      *.zip)       unzip $1       ;;
      *.Z)         uncompress $1  ;;
      *.7z)        7z x $1        ;;
      *)     yellow "'$1' cannot be extracted via extract()" ;;
    esac
  else
    red "'$1' is not a valid file"
  fi
}

# PATH

alias l.='ls -ld .*'
alias dotfiles="cd $DOTFILES"
alias ll='ls -hl'
alias duh="du -h . | grep '\./[^/]*$'"

function mcd() {
  mkdir -p "$1" && cd "$1";
}

# HEROKU

alias he="heroku"

function deploy () {
  if [ -z "$1" ]; then
    red 'deploy: missing required branch'
  elif [ -z "$2" ]; then
    red 'deploy: missing required app'
  else
    gco $1 &&
    ggpnp &&
    heroku maintenance:on --app $2 &&
    gp $2 $1:master &&
    heroku run rake db:migrate --app $2 &&
    heroku maintenance:off --app $2 &&
    heroku open --app $2
  fi
}

# CURL

function get() {
  curl -b /tmp/.curl_cookie -c /tmp/.curl_cookie "$@"
}

function post() {
  get -d "$@"
}

function put() {
  get -X PUT -d "$@"
}

function delete() {
  get -X DELETE "$@"
}

# UPDATE

function update () {
  # Upgrade dotfiles
  cyan "\nDotfiles..." &&
  dotfiles && ggpull &&
  homesick symlink dotfiles &&
  green "Dotfiles updated.\n" &&

  # Set OS X defaults
  cyan "Default OSX config..." &&
  $DOTFILES/osx/set-defaults.sh &&
  green "Default OSX config updated.\n" &&

  # Upgrade heroku toolbelt
  cyan "\nHeroku..." &&
  heroku update &&
  green "Heroku updated.\n" &&

  if [ -z "$1" ]; then
    cyan "\nReload..." &&
    clear &&
    reload
  fi
}

# XCODE

alias ios="open /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/Applications/iPhone\ Simulator.app"

# CLICKATELL

alias sms="nocorrect sms"

# CHROME

alias chromekill="ps ux | grep '[C]hrome Helper --type=renderer' | grep -v extension-process | tr -s ' ' | cut -d ' ' -f2 | xargs kill"
